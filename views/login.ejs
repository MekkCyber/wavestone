<div class="custom-container">
    <h3 class="title"><u>Lab parameters :</u></h3>
    <div class="selector-container" style="--num-selectors: 3;">
        
        <select id="captchaMethod" name="captchaSelector">
            <option value="MNIST">MNIST (only digits)</option>
            <option value="EMNIST">EMNIST (digits and letter)</option>
            <option value="Python">Python Captcha</option>
        </select>
        <select>
            <option value="option1">Option 1</option>
            <option value="option2">Option 2</option>
            <option value="option3">Option 3</option>
        </select>
        <select>
            <option value="option1">Option 1</option>
            <option value="option2">Option 2</option>
            <option value="option3">Option 3</option>
        </select>
    </div>
    <div class="horizontal-line"></div>

    <div class="attack-setup" style="--num-selectors: 3;">
        <div>
            <label>Select a labeler model : </label>
            <select id="labeler_model" name="">
                <option value="option1">MNIST</option>
                <option value="option2">EMNIST</option>
                <option value="option3">Python</option>
            </select>
        </div>
        <div>
            <input type="checkbox" id="postprocessing_checkbox" name="postprocessing_checkbox" checked/>
            <label for="postprocessing_checkbox">Enable Post-Processing</label>
        </div>
        <div>
            <button id="launch_button">Launch the attack!</button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the selected captcha type from the query parameters in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const captchaType = urlParams.get('captchaType');
    
        // Set the selected option in the captcha selector
        const captchaSelector = document.getElementById('captchaMethod');
        if (captchaSelector) {
            // Iterate over options and set the selected attribute for the corresponding captcha type
            Array.from(captchaSelector.options).forEach(option => {
                if (option.value === captchaType) {
                    option.selected = true;
                }
            });
        }
    
        // Add event listener to reload the page when captcha selector changes
        captchaSelector.addEventListener('change', function() {
            const selectedCaptchaType = this.value;
            window.location.href = '/auth/login?captchaType=' + selectedCaptchaType;
        });
    
        // Get all other selectors
        const selectors = document.querySelectorAll('.selector-container select:not(#captchaMethod)');
    
        // Add event listener to reload the page when any other selector changes
        selectors.forEach(selector => {
            selector.addEventListener('change', function() {
                // No need to capture captchaType here
                window.location.reload();
            });
        });
    });
</script>



<div class="row mt-5">
    <div class="col-md-6 m-auto">
        <div class="card card-body text-center">
            <h1 class="mb-3">
                <img src="/assets/secure-icon.png" alt="icon" width="20%" />
            </h1>
            <h2>
                Login
            </h2>
            <%- include ("./messages") %>
                <form action="/auth/login" method="POST">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" class="form-control" placeholder="Enter Email" />
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" class="form-control"
                            placeholder="Enter Password" />
                    </div>
                    <div class="form-group captcha">
                                               

                        <label for="captcha">Captcha</label>
                        <div id="randomImages"> 
                            <%if (captchaType === 'MNIST') {%>
                                <%console.log("Captcha : ", captcha_value);%>
                                <%for (let i = 0; i < 4; i++) {%>
                                    <% const random = captcha_value[i]; %>
                                    <% const randomFolder = imagePaths[parseInt(random)].folder; %>
                                    <% const randomFiles = imagePaths[parseInt(random)].files; %>
                                    <% const randomImageName = randomFiles[Math.floor(Math.random() * randomFiles.length)]; %>
                                    <img src="/attack_utils/images_dirs/<%= randomFolder %>/<%= randomImageName %>" alt="Random Image <%= i + 1 %>">
                                <%}%>
                            <%} else if (captchaType === 'EMNIST') {%>
                                <%const referenceList = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';%>
                                <%function getPosition(char) {%>
                                    <%return referenceList.indexOf(char);%>
                                <%}%>
                                <%for (let i = 0; i < 4; i++) {%>
                                    <% const random_char = captcha_value[i]; %>
                                    <% const position = getPosition(random_char);%>
                                    <% const randomFolder = imagePaths[position].folder; %>
                                    <% const randomFiles = imagePaths[position].files; %>
                                    <% const randomImageName = randomFiles[Math.floor(Math.random() * randomFiles.length)]; %>
                                    <img src="/attack_utils/images_dirs/<%= randomFolder %>/<%= randomImageName %>" alt="Random Image <%= i + 1 %>">
                                <%}%>
                            <%} else if (captchaType === 'Python') {%>
                                <%const referenceList = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';%>
                                <%function getPosition(char) {%>
                                    <%return referenceList.indexOf(char);%>
                                <%}%>
                                <%for (let i = 0; i < 4; i++) {%>
                                    <% const random_char = captcha_value[i]; %>
                                    <% const position = getPosition(random_char);%>
                                    <% const randomFolder = imagePaths[position].folder; %>
                                    <% const randomFiles = imagePaths[position].files; %>
                                    <% const randomImageName = randomFiles[Math.floor(Math.random() * randomFiles.length)]; %>
                                    <img src="/attack_utils/images_dirs/<%= randomFolder %>/<%= randomImageName %>" alt="Random Image <%= i + 1 %>">
                                <%}%>
                            <%} else {%>
                                <%for (let i = 0; i < 4; i++) {%>
                                    <% const random = captcha_value[i]; %>
                                    <% const randomFolder = imagePaths[parseInt(random)].folder; %>
                                    <% const randomFiles = imagePaths[parseInt(random)].files; %>
                                    <% const randomImageName = randomFiles[Math.floor(Math.random() * randomFiles.length)]; %>
                                    <img src="/attack_utils/images_dirs/<%= randomFolder %>/<%= randomImageName %>" alt="Random Image <%= i + 1 %>">
                                <%}%>
                            <%}%>
                          </div>   
                          <div>
                            
                          </div>  
                    </div>
                    <div class="form-group captcha">
                        <label for="form-group captcha">Enter the above characters :</label>
                        <%if (captchaType === 'MNIST') {%>
                            <input type="text" name="captcha_input" id="captcha_input" maxlength="4" oninput="validateInput_MNIST(this)" pattern="\d{4}" title="Please enter a 4-digit number">                         
                        <%} else if (captchaType === 'EMNIST') {%>
                            <input type="text" name="captcha_input" id="captcha_input" maxlength="4" oninput="validateInput_EMNIST(this)" pattern="[0-9a-zA-Z]{4}" title="Please enter a 4-character captcha value">
                        <%} else if (captchaType === 'Python') {%>
                            <input type="text" name="captcha_input" id="captcha_input" maxlength="4" oninput="validateInput_Python(this)" pattern="[0-9a-zA-Z]{4}" title="Please enter a 4-digit number">                         
                        <%} else {%>
                            <input type="text" name="captcha_input" id="captcha_input" maxlength="4" oninput="validateInput_MNIST(this)" pattern="\d{4}" title="Please enter a 4-digit number">     
                        <%}%>
                    </div>
                    <input type="hidden" name="captcha_value" value="<%= captcha_value %>">
                    <input type="hidden" name="lab_state" value="<%= captchaType%>">

                    <script>
                        function validateInput_MNIST(input) {
                            input.value = input.value.replace(/\D/g, '');
                            if (input.value.trim() === '') {
                                input.setCustomValidity('Please enter a 4-digit number');
                                enableSubmitButton(false);
                            } else if (/^\d{4}$/.test(input.value)) {
                            input.setCustomValidity('');
                            enableSubmitButton(true);
                            } else {
                            input.setCustomValidity('Please enter a 4-digit number');
                            enableSubmitButton(false);
                            } 
                        }
                        function validateInput_EMNIST(input) {
                            // Remove any non-alphanumeric characters from the input value
                            input.value = input.value.replace(/[^0-9a-zA-Z]/g, '');
                            
                            if (input.value.trim() === '') {
                                input.setCustomValidity('Please enter a 4-character string containing digits and/or letters (upper or lower case)');
                                enableSubmitButton(false);
                            } else if (/^[0-9a-zA-Z]{4}$/.test(input.value)) {
                                input.setCustomValidity('');
                                enableSubmitButton(true);
                            } else {
                                input.setCustomValidity('Please enter a 4-character string containing digits and/or letters (upper or lower case)');
                                enableSubmitButton(false);
                            } 
                        }
                        function enableSubmitButton(enable) {
                            var submitButton = document.querySelector('button[type="submit"]');
                            submitButton.disabled = !enable;
                        }
                    </script>
                    <button type="submit" class="btn btn-primary btn-block" disabled>Login</button>

                </form>
                <p class="mt-4">
                    New User? <a href="/auth/register">Register</a>
                </p>
                <p>
                    Forgot Password? <a href="/auth/forgot">Reset</a>
                </p>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reset the value inside the input field
            var captchaInput = document.getElementById('captcha_input');
            if (captchaInput) {
              captchaInput.value = '';
            }

            var urlParams = new URLSearchParams(window.location.search);
            var incorrectCaptcha = urlParams.get('incorrectCaptcha');

            if (incorrectCaptcha === 'true') {
            // Inform the user about the incorrect captcha
                captchaInput.setCustomValidity("Incorrect Captcha");
            }
        
            // Disable the submit button on page load
            enableSubmitButton(false);
        });
        function validateCaptcha() {
            return true
            var captchaInput = document.getElementById('captcha_input');
            var captchaValue = <%= captcha_value %>; // Get the server-side constant value

            // Check if the input value is equal to the constant captcha_value
            if (captchaInput.value.trim() === captchaValue.toString()) {
                console.log("bon");
                captchaInput.setCustomValidity('');
                enableSubmitButton(true);
                return true; // Allow form submission
            } else {
                console.log("Mauvais")
                enableSubmitButton(false);
                window.location.reload();
                var url = window.location.href + '?incorrectCaptcha=true';
                window.location.href = url;
                return false; // Prevent form submission
            }
        }

    </script>
    

</div>